<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Trucks - Mahajan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .screen { display: none; }
        .screen.active { display: flex; flex-direction: column; min-height: 100vh; }
        .status-badge {
            font-size: 10px;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .status-transit { background: #dcfce7; color: #166534; }
        .status-transit::before { background: #22c55e; }
        .status-idle { background: #f3f4f6; color: #6b7280; }
        .status-idle::before { background: #9ca3af; }
        .status-delivered { background: #dbeafe; color: #1e40af; }
        .status-delivered::before { background: #3b82f6; }
        .tab-btn {
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }
        .tab-btn.active { color: #1e40af; border-bottom-color: #1e40af; }
        .truck-thumb {
            width: 70px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .truck-thumb.active { border-color: #1e40af; }
        .action-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            gap: 4px;
        }
        #truckMap { height: 250px; width: 100%; border-radius: 12px; }
        .truck-card {
            background: white;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .truck-card:active { transform: scale(0.98); }
        .truck-card.active { border: 2px solid #1e40af; background: #eff6ff; }
        .bottom-nav-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            margin-bottom: 8px;
        }
        .chat-bubble.sent {
            background: #1e40af;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble.received {
            background: white;
            color: #1f2937;
            border-bottom-left-radius: 4px;
        }
        .delivered-banner {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 16px;
            text-align: center;
            animation: slideDown 0.5s ease;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>

<body>

    <!-- SCREEN 1: TRUCK LIST -->
    <div id="screenList" class="screen active">
        <!-- Header -->
        <div class="bg-slate-800 text-white px-4 py-4 sticky top-0 z-10">
            <div class="flex items-center justify-between">
                <h1 class="text-lg font-bold">My Trucks</h1>
                <div class="flex items-center gap-3">
                    <button onclick="refreshData()" class="p-2 hover:bg-slate-700 rounded-full">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                    <button onclick="State.clearAuth()" class="p-2 hover:bg-slate-700 rounded-full">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Status Summary -->
            <div class="flex items-center gap-4 mt-3 text-sm">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                    <span id="transitCount">0</span> In Transit
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                    <span id="idleCount">0</span> Idle
                </div>
            </div>
        </div>

        <!-- Mock Simulation Controls (Dev Only) -->
        <div class="bg-amber-50 border-b border-amber-200 px-4 py-3">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-amber-800">Dev: Mock Location Simulator</p>
                    <p class="text-xs text-amber-600" id="simStatus">No active simulations</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="startMockSimulation()" class="px-3 py-1 bg-green-500 text-white text-xs rounded-lg font-medium">Start</button>
                    <button onclick="stopMockSimulation()" class="px-3 py-1 bg-red-500 text-white text-xs rounded-lg font-medium">Stop</button>
                </div>
            </div>
        </div>

        <!-- Truck List -->
        <div class="flex-1 overflow-y-auto p-4" id="truckListContainer">
            <p class="text-center text-gray-500 py-8">Loading trucks...</p>
        </div>

        <!-- Bottom Navigation -->
        <div class="bg-white border-t p-3 flex gap-3 sticky bottom-0">
            <button class="bottom-nav-btn bg-slate-800 text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                Trucks & Ledger
            </button>
            <button onclick="openChatList()" class="bottom-nav-btn bg-amber-500 text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                Mahajan Chat
            </button>
        </div>
    </div>

    <!-- SCREEN 2: TRUCK DETAIL -->
    <div id="screenDetail" class="screen">
        <!-- Delivered Banner (hidden by default) -->
        <div id="deliveredBanner" class="delivered-banner hidden">
            <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="font-bold text-lg">Trip Delivered!</p>
            <p class="text-sm opacity-90">The truck has reached its destination</p>
        </div>

        <!-- Header with Back Button -->
        <div class="bg-slate-800 text-white px-4 py-3 flex items-center gap-3 sticky top-0 z-10">
            <button onclick="goBack()" class="p-2 -ml-2 hover:bg-slate-700 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <div class="flex-1">
                <h1 class="font-bold" id="detailHeaderTitle">HP 12 AB 3456</h1>
            </div>
            <span id="detailHeaderStatus" class="status-badge status-transit">In Transit</span>
        </div>

        <!-- Truck Image Banner -->
        <div class="relative h-44 bg-gradient-to-b from-blue-400 to-blue-600 overflow-hidden">
            <img id="detailTruckImage"
                 src="https://images.unsplash.com/photo-1601584115197-04ecc0da31d7?w=800&auto=format&fit=crop&q=60"
                 alt="Truck"
                 class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>

            <!-- Truck Number Overlay -->
            <div class="absolute bottom-3 left-4 right-4">
                <h2 class="text-2xl font-bold text-white" id="detailTruckNumber">HP 12 AB 3456</h2>
                <p class="text-white/80 text-sm" id="detailPartyInfo">Gupta Traders, Delhi → Delhi</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white border-b flex overflow-x-auto">
            <button onclick="switchTab('driver')" id="tabDriver" class="tab-btn active">Driver Details</button>
            <button onclick="switchTab('load')" id="tabLoad" class="tab-btn">Load Details</button>
            <button onclick="switchTab('location')" id="tabLocation" class="tab-btn">Track Location</button>
        </div>

        <!-- Tab Content -->
        <div class="flex-1 overflow-y-auto bg-gray-50">

            <!-- Driver Tab -->
            <div id="contentDriver" class="p-4">
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-slate-200 rounded-full flex items-center justify-center">
                            <svg class="w-7 h-7 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800" id="detailDriverName">Driver Name</h3>
                            <p class="text-sm text-gray-500" id="detailDriverPhone">+91 9876543210</p>
                        </div>
                        <button onclick="callDriver()" class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="mt-3 pt-3 border-t text-sm text-gray-500">
                        <span id="detailDriverLicense">License: DL-1234567890</span>
                    </div>
                </div>

                <!-- Party Details -->
                <h4 class="font-bold text-gray-700 mt-5 mb-3 px-1">Party Details</h4>
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <p class="font-medium text-gray-800" id="detailPartyName">Gupta Traders</p>
                    <p class="text-sm text-gray-500" id="detailPartyPhone">+91 9876543210</p>
                    <p class="text-sm text-gray-500 mt-1" id="detailRoute">Delhi → Mumbai</p>
                </div>
            </div>

            <!-- Load Tab -->
            <div id="contentLoad" class="p-4 hidden">
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="text-left px-4 py-3 text-sm font-semibold text-gray-600">Item</th>
                                <th class="text-center px-4 py-3 text-sm font-semibold text-gray-600">Bags</th>
                                <th class="text-right px-4 py-3 text-sm font-semibold text-gray-600">Weight</th>
                            </tr>
                        </thead>
                        <tbody id="loadTable" class="divide-y">
                            <tr>
                                <td colspan="3" class="px-4 py-8 text-center text-gray-400">No items loaded</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Location Tab -->
            <div id="contentLocation" class="p-4 hidden">
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div id="truckMap"></div>
                </div>

                <!-- Trip Progress Timeline -->
                <div class="bg-white rounded-xl p-4 shadow-sm mt-4">
                    <div class="flex items-center justify-between mb-3">
                        <p class="text-sm font-medium text-gray-700">Trip Progress</p>
                        <span class="text-xs text-blue-600 font-medium" id="progressText">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span id="originLabel">Origin</span>
                        <span id="destLabel">Destination</span>
                    </div>
                </div>

                <!-- Timeline Events -->
                <div class="bg-white rounded-xl p-4 shadow-sm mt-4">
                    <p class="text-sm font-medium text-gray-700 mb-3">Timeline</p>
                    <div id="tripTimeline" class="space-y-3">
                        <!-- Timeline events will be rendered here -->
                        <div class="flex items-start gap-3">
                            <div class="w-3 h-3 bg-green-500 rounded-full mt-1 shrink-0"></div>
                            <div>
                                <p class="text-sm font-medium text-gray-800">Trip Started</p>
                                <p class="text-xs text-gray-500">Waiting for updates...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location Details -->
                <div class="bg-white rounded-xl p-4 shadow-sm mt-4">
                    <div class="flex justify-between text-sm">
                        <div>
                            <p class="text-gray-500">Current Location</p>
                            <p class="font-medium text-gray-800" id="detailCurrentLoc">Fetching...</p>
                        </div>
                        <div class="text-right">
                            <p class="text-gray-500">Last Updated</p>
                            <p class="font-medium text-gray-800" id="detailLastUpdate">-</p>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm mt-3 pt-3 border-t">
                        <div>
                            <p class="text-gray-500">Speed</p>
                            <p class="font-medium text-gray-800" id="detailSpeed">- km/h</p>
                        </div>
                        <div class="text-right">
                            <p class="text-gray-500">Route Progress</p>
                            <p class="font-medium text-gray-800" id="detailRouteProgress">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Other Trucks Thumbnails -->
        <div class="bg-white border-t px-4 py-3">
            <div class="flex gap-2 overflow-x-auto pb-1" id="truckThumbnails">
                <!-- Thumbnails will be rendered here -->
            </div>
        </div>

        <!-- Bottom Actions -->
        <div class="bg-white border-t p-3 flex gap-2 sticky bottom-0">
            <button onclick="callDriver()" class="action-btn bg-green-500 text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                </svg>
                Call Driver
            </button>
            <button onclick="switchTab('location')" class="action-btn bg-blue-600 text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Track Location
            </button>
            <button onclick="openTripChat()" class="action-btn bg-amber-500 text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                Mahajan Chat
            </button>
        </div>
    </div>

    <!-- SCREEN 3: CHAT LIST -->
    <div id="screenChatList" class="screen">
        <!-- Header -->
        <div class="bg-slate-800 text-white px-4 py-3 flex items-center gap-3 sticky top-0 z-10">
            <button onclick="goBackFromChat()" class="p-2 -ml-2 hover:bg-slate-700 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <h1 class="font-bold flex-1">Mahajan Chat</h1>
        </div>

        <!-- Chat List -->
        <div class="flex-1 overflow-y-auto" id="chatListContainer">
            <p class="text-center text-gray-500 py-8">Loading chats...</p>
        </div>
    </div>

    <!-- SCREEN 4: CHAT MESSAGES -->
    <div id="screenChatMessages" class="screen">
        <!-- Header -->
        <div class="bg-slate-800 text-white px-4 py-3 flex items-center gap-3 sticky top-0 z-10">
            <button onclick="goBackToChats()" class="p-2 -ml-2 hover:bg-slate-700 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <div class="flex-1">
                <h1 class="font-bold" id="chatHeaderTitle">Chat</h1>
                <p class="text-xs text-slate-300" id="chatHeaderSubtitle">Trip Chat</p>
            </div>
        </div>

        <!-- Messages -->
        <div class="flex-1 overflow-y-auto p-4 bg-gray-100" id="chatMessagesContainer">
            <p class="text-center text-gray-500 py-8">Loading messages...</p>
        </div>

        <!-- Message Input -->
        <div class="bg-white border-t p-3 sticky bottom-0">
            <form onsubmit="sendMessage(event)" class="flex gap-2">
                <input type="text" id="messageInput" placeholder="Type a message..."
                       class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:border-blue-500">
                <button type="submit" class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <script>
        // State
        let allTrucks = [];
        let allTrips = [];
        let allDrivers = [];
        let selectedTruck = null;
        let selectedTrip = null;
        let truckMap = null;
        let truckMarker = null;
        let previousScreen = 'screenList';
        let currentChatThread = null;
        let currentChatTitle = '';

        // Truck images array for variety
        const truckImages = [
            'https://images.unsplash.com/photo-1601584115197-04ecc0da31d7?w=400&auto=format&fit=crop&q=60',
            'https://images.unsplash.com/photo-1586191582056-12a7de25cddc?w=400&auto=format&fit=crop&q=60',
            'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&auto=format&fit=crop&q=60',
            'https://images.unsplash.com/photo-1562674818-f87e40c40bff?w=400&auto=format&fit=crop&q=60'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (!State.token) {
                window.location.href = 'index.html';
                return;
            }
            Socket.connect();
            setupSocketListeners();
            loadAllData();
            checkSimulationStatus();
        });

        // Setup Socket Listeners for real-time updates
        function setupSocketListeners() {
            // Listen for trip status updates (DELIVERED, etc.)
            Socket.on('trip:status-update', (data) => {
                console.log('Trip status update received:', data);
                if (data.status === 'DELIVERED') {
                    handleTripDelivered(data.tripId);
                }
                // Refresh data to update UI
                loadAllData();
            });

            // Listen for new chat messages
            Socket.on('chat:new-message', (data) => {
                console.log('New chat message:', data);
                if (currentChatThread === data.threadId) {
                    appendMessage(data);
                }
            });
        }

        // Handle trip delivered
        function handleTripDelivered(tripId) {
            UI.showToast('Trip has been delivered!');

            // If viewing this trip, show the delivered banner and update UI
            if (selectedTrip?.id === tripId) {
                document.getElementById('deliveredBanner').classList.remove('hidden');

                // Update status badge
                const headerStatus = document.getElementById('detailHeaderStatus');
                headerStatus.className = 'status-badge status-delivered';
                headerStatus.textContent = 'Delivered';

                // Update progress bar to 100%
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressText').textContent = '100%';

                // Add delivered event to timeline
                addTimelineEvent('delivered', 'Trip Delivered!', new Date(), 'green');
            }
        }

        // Load Data
        async function loadAllData() {
            try {
                const [trucksRes, tripsRes, driversRes] = await Promise.all([
                    API.trucks.list(),
                    API.trips.list(),
                    API.drivers.list()
                ]);

                allTrucks = trucksRes.data?.trucks || [];
                allTrips = tripsRes.data?.trips || [];
                allDrivers = driversRes.data?.drivers || [];

                // Update counts
                const transitCount = allTrips.filter(t => t.status === 'IN_TRANSIT').length;
                document.getElementById('transitCount').textContent = transitCount;
                document.getElementById('idleCount').textContent = allTrucks.length - transitCount;

                renderTruckList();
            } catch (err) {
                console.error('Failed to load data:', err);
                document.getElementById('truckListContainer').innerHTML =
                    '<p class="text-center text-red-500 py-8">Failed to load trucks</p>';
            }
        }

        function refreshData() {
            loadAllData();
            checkSimulationStatus();
            UI.showToast('Refreshed');
        }

        // Mock Simulation Controls
        async function startMockSimulation() {
            // Find first IN_TRANSIT trip
            const transitTrip = allTrips.find(t => t.status === 'IN_TRANSIT');
            if (!transitTrip) {
                UI.showToast('No active trip to simulate', 'error');
                return;
            }

            try {
                const res = await fetch(`http://localhost:3000/api/dev/mock-location/start/${transitTrip.id}?interval=2000`, {
                    method: 'POST'
                });
                const data = await res.json();
                if (data.success) {
                    UI.showToast('Simulation started!');
                    checkSimulationStatus();
                } else {
                    UI.showToast(data.error || 'Failed to start', 'error');
                }
            } catch (err) {
                UI.showToast('Failed to start simulation', 'error');
            }
        }

        async function stopMockSimulation() {
            try {
                const res = await fetch('http://localhost:3000/api/dev/mock-location/stop-all', {
                    method: 'POST'
                });
                const data = await res.json();
                UI.showToast('Simulation stopped');
                checkSimulationStatus();
            } catch (err) {
                UI.showToast('Failed to stop', 'error');
            }
        }

        async function checkSimulationStatus() {
            try {
                const res = await fetch('http://localhost:3000/api/dev/mock-location/status');
                const data = await res.json();
                if (data.activeSimulations > 0) {
                    const sim = data.simulations[0];
                    document.getElementById('simStatus').textContent =
                        `Active: Trip ${sim.tripId.substring(0,8)}... (${sim.currentIndex}/${sim.totalPoints} points)`;
                } else {
                    document.getElementById('simStatus').textContent = 'No active simulations';
                }
            } catch (err) {
                document.getElementById('simStatus').textContent = 'Status unavailable';
            }
        }

        // Render Truck List
        function renderTruckList() {
            const container = document.getElementById('truckListContainer');

            if (allTrucks.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No trucks found</p>';
                return;
            }

            container.innerHTML = allTrucks.map((truck, index) => {
                const activeTrip = allTrips.find(t => t.truckId === truck.id && t.status === 'IN_TRANSIT');
                const deliveredTrip = allTrips.find(t => t.truckId === truck.id && t.status === 'DELIVERED');

                let statusClass = 'status-idle';
                let statusText = 'Idle';
                let route = 'No active trip';

                if (activeTrip) {
                    statusClass = 'status-transit';
                    statusText = 'In Transit';
                    route = `${activeTrip.startPoint || 'Origin'} → ${activeTrip.endPoint || 'Dest'}`;
                } else if (deliveredTrip) {
                    statusClass = 'status-delivered';
                    statusText = 'Delivered';
                    route = `${deliveredTrip.startPoint || 'Origin'} → ${deliveredTrip.endPoint || 'Dest'}`;
                }

                const imgUrl = truckImages[index % truckImages.length];

                return `
                    <div onclick="openTruckDetail('${truck.id}')" class="truck-card">
                        <img src="${imgUrl}" alt="Truck" class="w-16 h-12 rounded-lg object-cover">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between gap-2">
                                <h3 class="font-bold text-gray-800 truncate">${truck.registrationNumber}</h3>
                                <span class="status-badge ${statusClass} shrink-0">${statusText}</span>
                            </div>
                            <p class="text-sm text-gray-500 truncate">${route}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open Truck Detail
        function openTruckDetail(truckId) {
            selectedTruck = allTrucks.find(t => t.id === truckId);
            if (!selectedTruck) return;

            // Find latest trip for this truck
            selectedTrip = allTrips.find(t => t.truckId === truckId && (t.status === 'IN_TRANSIT' || t.status === 'DELIVERED'));
            const truckIndex = allTrucks.findIndex(t => t.id === truckId);
            const imgUrl = truckImages[truckIndex % truckImages.length];

            // Hide delivered banner by default
            document.getElementById('deliveredBanner').classList.add('hidden');

            // Update header
            document.getElementById('detailHeaderTitle').textContent = selectedTruck.registrationNumber;
            const headerStatus = document.getElementById('detailHeaderStatus');

            if (selectedTrip?.status === 'DELIVERED') {
                headerStatus.className = 'status-badge status-delivered';
                headerStatus.textContent = 'Delivered';
            } else if (selectedTrip) {
                headerStatus.className = 'status-badge status-transit';
                headerStatus.textContent = 'In Transit';
            } else {
                headerStatus.className = 'status-badge status-idle';
                headerStatus.textContent = 'Idle';
            }

            // Update image and truck info
            document.getElementById('detailTruckImage').src = imgUrl;
            document.getElementById('detailTruckNumber').textContent = selectedTruck.registrationNumber;

            // Party info
            if (selectedTrip) {
                const partyName = selectedTrip.destinationOrg?.name || 'Unknown Party';
                const route = `${selectedTrip.startPoint || 'Origin'} → ${selectedTrip.endPoint || 'Destination'}`;
                document.getElementById('detailPartyInfo').textContent = `${partyName}, ${route}`;
                document.getElementById('detailPartyName').textContent = partyName;
                document.getElementById('detailPartyPhone').textContent = selectedTrip.destinationOrg?.phone || '-';
                document.getElementById('detailRoute').textContent = route;

                // Subscribe to trip updates
                Socket.subscribeTrip(selectedTrip.id);
            } else {
                document.getElementById('detailPartyInfo').textContent = 'No active trip';
                document.getElementById('detailPartyName').textContent = '-';
                document.getElementById('detailPartyPhone').textContent = '-';
                document.getElementById('detailRoute').textContent = '-';
            }

            // Driver info
            if (selectedTrip?.driver) {
                document.getElementById('detailDriverName').textContent = selectedTrip.driver.user?.name || 'Unknown';
                document.getElementById('detailDriverPhone').textContent = selectedTrip.driver.user?.phone || '-';
                document.getElementById('detailDriverLicense').textContent = `License: ${selectedTrip.driver.licenseNumber || 'N/A'}`;
            } else {
                document.getElementById('detailDriverName').textContent = 'No driver assigned';
                document.getElementById('detailDriverPhone').textContent = '-';
                document.getElementById('detailDriverLicense').textContent = '-';
            }

            // Load details
            const loadTable = document.getElementById('loadTable');
            if (selectedTrip?.loadCard?.items && selectedTrip.loadCard.items.length > 0) {
                loadTable.innerHTML = selectedTrip.loadCard.items.map(item => `
                    <tr>
                        <td class="px-4 py-3 font-medium text-gray-800">${item.itemName}</td>
                        <td class="px-4 py-3 text-center text-gray-600">${item.quantity} ${item.unit || 'Bags'}</td>
                        <td class="px-4 py-3 text-right text-gray-600">${item.weightKg || '-'} Kg</td>
                    </tr>
                `).join('');
            } else {
                loadTable.innerHTML = '<tr><td colspan="3" class="px-4 py-8 text-center text-gray-400">No items loaded</td></tr>';
            }

            // Render thumbnails
            renderTruckThumbnails(truckId);

            // Switch to detail screen
            switchScreen('screenDetail');
            switchTab('driver');
        }

        // Render Truck Thumbnails
        function renderTruckThumbnails(currentTruckId) {
            const container = document.getElementById('truckThumbnails');
            container.innerHTML = allTrucks.map((truck, index) => {
                const imgUrl = truckImages[index % truckImages.length];
                const isActive = truck.id === currentTruckId;
                return `
                    <img onclick="openTruckDetail('${truck.id}')"
                         src="${imgUrl}"
                         alt="${truck.registrationNumber}"
                         class="truck-thumb ${isActive ? 'active' : ''}"
                         title="${truck.registrationNumber}">
                `;
            }).join('');
        }

        // Switch Tab
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');

            // Update content
            document.getElementById('contentDriver').classList.add('hidden');
            document.getElementById('contentLoad').classList.add('hidden');
            document.getElementById('contentLocation').classList.add('hidden');
            document.getElementById(`content${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('hidden');

            // Initialize map if location tab
            if (tab === 'location') {
                initMap();
            }
        }

        // Initialize Map
        function initMap() {
            setTimeout(() => {
                if (!truckMap) {
                    truckMap = L.map('truckMap').setView([20.5937, 78.9629], 5);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap'
                    }).addTo(truckMap);
                }
                truckMap.invalidateSize();

                if (selectedTrip) {
                    loadLocation();
                } else {
                    document.getElementById('detailCurrentLoc').textContent = 'No active trip';
                    document.getElementById('detailLastUpdate').textContent = '-';
                }
            }, 100);
        }

        // Timeline events storage
        let timelineEvents = [];

        // Load Location
        async function loadLocation() {
            if (!selectedTrip) return;

            // Set origin/destination labels
            document.getElementById('originLabel').textContent = selectedTrip.startPoint || 'Origin';
            document.getElementById('destLabel').textContent = selectedTrip.endPoint || 'Destination';

            // Reset timeline
            timelineEvents = [{
                type: 'start',
                title: 'Trip Started',
                time: selectedTrip.startTime || selectedTrip.createdAt,
                icon: 'green'
            }];
            renderTimeline();

            try {
                const res = await API.tracking.getLatest(selectedTrip.id);
                if (res.data) {
                    updateLocationData(res.data);
                }
            } catch (err) {
                document.getElementById('detailCurrentLoc').textContent = 'Location unavailable';
            }

            // Listen for live updates
            Socket.on('tracking:location-update', (data) => {
                if (data.tripId === selectedTrip?.id) {
                    updateLocationData(data);
                }
            });
        }

        function updateLocationData(data) {
            const lat = data.latitude || data.lat;
            const lng = data.longitude || data.lng;

            if (!lat || !lng) return;

            // Update map
            const latLng = [lat, lng];
            if (truckMarker) {
                truckMarker.setLatLng(latLng);
            } else {
                truckMarker = L.marker(latLng).addTo(truckMap);
            }
            truckMap.setView(latLng, 12);

            // Update location text
            document.getElementById('detailCurrentLoc').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            document.getElementById('detailLastUpdate').textContent = new Date().toLocaleTimeString();

            // Update speed if available
            if (data.speed) {
                document.getElementById('detailSpeed').textContent = `${data.speed.toFixed(0)} km/h`;
            }

            // Update route progress if available (from mock simulation)
            if (data._routeProgress) {
                document.getElementById('detailRouteProgress').textContent = data._routeProgress;

                // Parse progress and update progress bar
                const parts = data._routeProgress.split('/');
                if (parts.length === 2) {
                    const current = parseInt(parts[0]);
                    const total = parseInt(parts[1]);
                    const percentage = Math.round((current / total) * 100);

                    document.getElementById('progressBar').style.width = `${percentage}%`;
                    document.getElementById('progressText').textContent = `${percentage}%`;

                    // Add timeline event for significant progress points
                    if (current === 1) {
                        addTimelineEvent('checkpoint', 'Started Moving', new Date(), 'blue');
                    } else if (percentage >= 25 && !timelineEvents.find(e => e.title === '25% Complete')) {
                        addTimelineEvent('checkpoint', '25% Complete', new Date(), 'blue');
                    } else if (percentage >= 50 && !timelineEvents.find(e => e.title === 'Halfway Point')) {
                        addTimelineEvent('checkpoint', 'Halfway Point', new Date(), 'blue');
                    } else if (percentage >= 75 && !timelineEvents.find(e => e.title === '75% Complete')) {
                        addTimelineEvent('checkpoint', '75% Complete', new Date(), 'blue');
                    } else if (percentage >= 90 && !timelineEvents.find(e => e.title === 'Almost There')) {
                        addTimelineEvent('checkpoint', 'Almost There', new Date(), 'yellow');
                    }
                }
            }
        }

        function addTimelineEvent(type, title, time, icon) {
            timelineEvents.push({ type, title, time, icon });
            renderTimeline();
        }

        function renderTimeline() {
            const container = document.getElementById('tripTimeline');
            const iconColors = {
                green: 'bg-green-500',
                blue: 'bg-blue-500',
                yellow: 'bg-yellow-500',
                red: 'bg-red-500'
            };

            container.innerHTML = timelineEvents.map(event => {
                const timeStr = event.time ? new Date(event.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                return `
                    <div class="flex items-start gap-3">
                        <div class="w-3 h-3 ${iconColors[event.icon] || 'bg-gray-400'} rounded-full mt-1 shrink-0"></div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-800">${event.title}</p>
                            <p class="text-xs text-gray-500">${timeStr}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateMapLocation(lat, lng) {
            updateLocationData({ latitude: lat, longitude: lng });
        }

        // Screen Navigation
        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function goBack() {
            switchScreen('screenList');
            // Clean up
            if (selectedTrip) {
                Socket.unsubscribeTrip(selectedTrip.id);
                Socket.off('tracking:location-update');
            }
            if (truckMarker && truckMap) {
                truckMap.removeLayer(truckMarker);
                truckMarker = null;
            }
        }

        function goBackFromChat() {
            switchScreen(previousScreen);
        }

        function goBackToChats() {
            if (currentChatThread) {
                Socket.leaveChat(currentChatThread);
            }
            switchScreen('screenChatList');
        }

        // Actions
        function callDriver() {
            if (selectedTrip?.driver?.user?.phone) {
                window.location.href = `tel:${selectedTrip.driver.user.phone}`;
            } else {
                UI.showToast('No driver phone available', 'error');
            }
        }

        // Chat Functions
        function openChatList() {
            previousScreen = document.querySelector('.screen.active').id;
            switchScreen('screenChatList');
            loadChats();
        }

        async function openTripChat() {
            if (!selectedTrip) {
                UI.showToast('No active trip for chat', 'error');
                return;
            }

            // Try to find existing chat thread for this trip or create one
            try {
                const res = await API.chat.getThreads();
                const threads = res.data || [];
                let tripThread = threads.find(t => t.tripId === selectedTrip.id);

                if (!tripThread) {
                    // Create new chat thread for this trip
                    const createRes = await API.chat.createThread({
                        tripId: selectedTrip.id,
                        title: `Trip: ${selectedTruck?.registrationNumber || 'Unknown'}`
                    });
                    tripThread = createRes.data;
                }

                if (tripThread) {
                    openChatThread(tripThread.id, tripThread.title || `Trip Chat`);
                }
            } catch (err) {
                UI.showToast('Failed to open chat', 'error');
            }
        }

        async function loadChats() {
            try {
                const res = await API.chat.getThreads();
                const threads = res.data || [];

                if (threads.length === 0) {
                    document.getElementById('chatListContainer').innerHTML =
                        '<p class="text-center text-gray-500 py-8">No conversations yet</p>';
                    return;
                }

                document.getElementById('chatListContainer').innerHTML = threads.map(t => `
                    <div onclick="openChatThread('${t.id}', '${t.title || 'Chat'}')" class="p-4 border-b bg-white flex items-center gap-3 cursor-pointer active:bg-gray-50">
                        <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium text-gray-800">${t.title || 'Chat'}</p>
                            <p class="text-sm text-gray-500 truncate">${t.lastMessage || 'No messages yet'}</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                `).join('');
            } catch (err) {
                document.getElementById('chatListContainer').innerHTML =
                    '<p class="text-center text-red-500 py-8">Failed to load chats</p>';
            }
        }

        async function openChatThread(threadId, title) {
            currentChatThread = threadId;
            currentChatTitle = title;

            document.getElementById('chatHeaderTitle').textContent = title;
            document.getElementById('chatHeaderSubtitle').textContent = 'Loading...';

            switchScreen('screenChatMessages');

            // Join chat room for real-time updates
            Socket.joinChat(threadId);

            try {
                const res = await API.chat.getMessages(threadId);
                const messages = res.data?.messages || [];

                document.getElementById('chatHeaderSubtitle').textContent = `${messages.length} messages`;

                renderMessages(messages);
            } catch (err) {
                document.getElementById('chatMessagesContainer').innerHTML =
                    '<p class="text-center text-red-500 py-8">Failed to load messages</p>';
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('chatMessagesContainer');

            if (messages.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No messages yet. Start the conversation!</p>';
                return;
            }

            // Sort by createdAt ascending
            messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

            container.innerHTML = messages.map(m => {
                const isMine = m.senderId === State.user?.id;
                const time = new Date(m.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                return `
                    <div class="chat-bubble ${isMine ? 'sent' : 'received'}">
                        <p>${m.content}</p>
                        <p class="text-xs ${isMine ? 'text-blue-200' : 'text-gray-400'} mt-1">${time}</p>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function appendMessage(message) {
            const container = document.getElementById('chatMessagesContainer');
            const isMine = message.senderId === State.user?.id;
            const time = new Date(message.createdAt || Date.now()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isMine ? 'sent' : 'received'}`;
            bubble.innerHTML = `
                <p>${message.content}</p>
                <p class="text-xs ${isMine ? 'text-blue-200' : 'text-gray-400'} mt-1">${time}</p>
            `;
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content || !currentChatThread) return;

            input.value = '';

            try {
                const res = await API.chat.sendMessage(currentChatThread, content);
                if (res.data) {
                    appendMessage(res.data);
                }
            } catch (err) {
                UI.showToast('Failed to send message', 'error');
                input.value = content; // Restore message
            }
        }

        // Periodically check simulation status
        setInterval(checkSimulationStatus, 5000);
    </script>
</body>

</html>
