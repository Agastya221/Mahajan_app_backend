// prisma/schema.prisma
// ✅ Mahajan Network Platform v2.0
// UPDATED: Multi-item trips, flexible items, custom units, rate/amount fields
// Source Mahajan (collector) -> Destination Mahajan (city/distributor)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  MAHAJAN
  DRIVER
}

enum DriverPaymentPaidBy {
  SOURCE        // Source mahajan pays full amount
  DESTINATION   // Destination mahajan pays full amount
  SPLIT         // Split between both mahajans
}

enum DriverPaymentStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  DISPUTED
}

enum MahajanRoleType {
  SOURCE_COLLECTOR
  DESTINATION_DISTRIBUTOR
  BOTH
}

enum TripStatus {
  CREATED
  ASSIGNED
  LOADED
  IN_TRANSIT
  ARRIVED
  REACHED
  DELIVERED
  COMPLETED
  CLOSED
  CANCELLED
  DISPUTED
}

enum TripEventType {
  TRIP_CREATED
  ASSIGNED
  LOAD_COMPLETED
  IN_TRANSIT
  ARRIVED
  DELIVERED
  TRIP_COMPLETED
  POD_UPLOADED
  PAYMENT_RECORDED
  DISPUTE_RAISED
  DISPUTE_RESOLVED
  TRIP_CANCELLED
  TRIP_EDITED
  DRIVER_CHANGED
  TRUCK_CHANGED
  CLOSED
  NOTE
}

// ✅ UPDATED: Added more common units
enum QuantityUnit {
  KG
  BAG
  TON
  CRATE
  BOX
  BUNDLE    // NEW: Common for leafy vegetables
  TRAY      // NEW: For tomatoes, eggs
  SACK      // NEW: Same as bag but larger
  PETI      // NEW: Hindi for box/crate
  DOZEN     // NEW: For eggs, lemons
  PIECE     // NEW: For large items (watermelon)
  QUINTAL   // NEW: 100 kg (common in mandi)
  OTHER     // When custom unit is needed
}

enum PaymentTag {
  ADVANCE
  PARTIAL
  FINAL
  DUE
  OTHER
}

enum PaymentStatus {
  PENDING           // Payment request created, not yet paid
  MARKED_AS_PAID    // Sender claims they have paid
  CONFIRMED         // Receiver confirms payment received
  DISPUTED          // Receiver disputes the payment
  CANCELLED         // Payment request cancelled
}

enum AttachmentType {
  LOAD_PHOTO
  RECEIVE_PHOTO
  PAYMENT_PROOF
  INVOICE
  RECEIPT
  CHAT_IMAGE
  CHAT_DOCUMENT
  CHAT_AUDIO
  OTHER
}

enum ChatMessageType {
  TEXT
  IMAGE
  PDF
  FILE
  AUDIO
  SYSTEM_MESSAGE
  PAYMENT_UPDATE
  INVOICE_UPDATE
  LOCATION
  TRIP_CARD
  PAYMENT_REQUEST
  INVOICE_CARD
  DATA_GRID
}

enum LedgerDirection {
  PAYABLE
  RECEIVABLE
}

// ============================================
// ORGANIZATION & USER MODELS
// ============================================

model Org {
  id        String          @id @default(cuid())
  name      String
  city      String?
  phone     String?
  address   String?
  gstin     String?         @unique
  roleType  MahajanRoleType @default(BOTH)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members   OrgMember[]
  trucks    Truck[]

  sourceTrips      Trip[] @relation("SourceOrgTrips")
  destinationTrips Trip[] @relation("DestinationOrgTrips")

  accountsAsOwner        Account[] @relation("AccountOwnerOrg")
  accountsAsCounterparty Account[] @relation("AccountCounterpartyOrg")

  chatThreads ChatThread[]
  
  // ✅ NEW: Item Master & Export Logs
  items      Item[]
  exportLogs ExportLog[]
}

model User {
  id           String    @id @default(cuid())
  role         UserRole
  name         String
  phone        String    @unique
  passwordHash String?   // Optional — OTP-only users won't have a password
  gstin        String?   @unique  // Optional GST number for mahajans
  isVerified   Boolean   @default(false)  // True when GST is verified — shows badge
  status       String    @default("ACTIVE")
  suspendedAt  DateTime?
  bannedAt     DateTime?
  statusReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships          OrgMember[]
  driverProfile        DriverProfile?
  sentMessages         ChatMessage[] @relation("SentMessages")
  createdLoadCards     TripLoadCard[]
  createdReceiveCards  TripReceiveCard[] @relation("CreatedReceiveCards")
  approvedReceiveCards TripReceiveCard[] @relation("ApprovedReceiveCards")
  createdEvents        TripEvent[]
  exportLogs           ExportLog[]
  refreshTokens        RefreshToken[]

  // Payment confirmation flow relations
  markedPaidPayments   Payment[] @relation("MarkedPaidPayments")
  confirmedPayments    Payment[] @relation("ConfirmedPayments")
  disputedPayments     Payment[] @relation("DisputedPayments")

  @@index([status])
}

model RefreshToken {
  id         String    @id @default(cuid())
  token      String    @unique  // opaque random hex string
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  family     String             // token family ID for rotation / breach detection
  expiresAt  DateTime
  revokedAt  DateTime?
  deviceInfo String?            // optional user-agent or device label

  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([family])
  @@index([expiresAt])
}

model OrgMember {
  id        String   @id @default(cuid())
  orgId     String
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, userId])
  @@index([userId])
  @@index([orgId])
}

model DriverProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  licenseNo      String?
  emergencyPhone String?
  altPhone       String?  // Alternate phone for emergencies (accident/breakdown)
  notes          String?
  deviceId       String?  @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trips     Trip[]   @relation("DriverTrips")
  locations TripLocation[]
}

model Truck {
  id        String   @id @default(cuid())
  orgId     String
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  number    String   @unique
  type      String?
  capacity  Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trips     Trip[]
}

// ============================================
// ✅ NEW: FLEXIBLE ITEM MASTER
// Mahajans can add any item: "Green Apple", "Kinnaur Apple", etc.
// ============================================

model Item {
  id        String   @id @default(cuid())
  
  // Item can be org-specific or global (null orgId = shared)
  orgId     String?
  org       Org?     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  name      String   // "Kinnaur Apple", "Green Apple", "Potato (Local)"
  nameHindi String?  // "किन्नौर सेब" - for Hindi-first users
  category  String?  // "Fruit", "Vegetable", "Packaging"
  hsn       String?  // HSN code for GST (optional)
  
  // Default unit for this item
  defaultUnit       QuantityUnit @default(KG)
  defaultCustomUnit String?      // If defaultUnit is OTHER
  
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  loadItems    LoadItem[]
  receiveItems ReceiveItem[]
  
  @@unique([orgId, name])
  @@index([orgId, isActive])
  @@index([category])
  @@index([name])
}

// ============================================
// TRIP & TRACKING MODELS
// ============================================

model Trip {
  id               String   @id @default(cuid())
  sourceOrgId      String
  sourceOrg        Org      @relation("SourceOrgTrips", fields: [sourceOrgId], references: [id], onDelete: Restrict)
  destinationOrgId String
  destinationOrg   Org      @relation("DestinationOrgTrips", fields: [destinationOrgId], references: [id], onDelete: Restrict)
  truckId          String
  truck            Truck    @relation(fields: [truckId], references: [id], onDelete: Restrict)
  driverId         String?
  driver           DriverProfile? @relation("DriverTrips", fields: [driverId], references: [id], onDelete: SetNull)

  // ✅ Who created this trip (for cancel permission)
  createdByUserId  String?

  pendingDriverPhone   String?  // Phone of driver who hasn't registered yet
  pendingReceiverPhone String?  // Phone of receiver (dest org contact) who hasn't registered yet

  // ✅ Guest user registration status
  driverRegistered     Boolean @default(true)
  receiverRegistered   Boolean @default(true)

  // ✅ Feature flags (computed from registration status at creation, updated on linking)
  trackingEnabled      Boolean @default(true)   // Requires registered driver
  paymentEnabled       Boolean @default(true)   // Requires registered receiver (dest org)

  startPoint        String?
  endPoint          String?
  startTime         DateTime?
  eta               DateTime?
  estimatedDistance Float?
  estimatedArrival  DateTime?
  notes             String?
  status            TripStatus @default(CREATED)

  // ✅ Structured addresses (mandi-style, like Flipkart)
  sourceAddress      Json?   // { label, line1, line2, city, state, pincode, landmark, contactName, contactPhone }
  destinationAddress Json?   // same structure

  // ✅ Soft cancel fields
  cancelledAt     DateTime?
  cancelledBy     String?    // userId who cancelled
  cancelReason    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locations      TripLocation[]
  latestLoc      TripLatestLocation?
  loadCard       TripLoadCard?
  receiveCard    TripReceiveCard?
  events         TripEvent[]
  disputes       Dispute[]
  invoices       Invoice[]
  payments       Payment[]
  ledgerEntries  LedgerEntry[]
  chatThreads    ChatThread[]
  driverPayment  DriverPayment?

  @@index([sourceOrgId, status, createdAt])
  @@index([destinationOrgId, status, createdAt])
  @@index([truckId, createdAt])
  @@index([driverId, createdAt])
  @@index([driverId, status])
  @@index([truckId, status])
  @@index([pendingDriverPhone])
  @@index([pendingReceiverPhone])
  @@index([createdByUserId])
}

// ============================================
// ✅ UPDATED: TripLoadCard (Multi-Item Support)
// ============================================

model TripLoadCard {
  id       String   @id @default(cuid())
  tripId   String   @unique
  trip     Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  loadedAt DateTime @default(now())
  remarks  String?
  
  // ✅ NEW: Summary fields (auto-calculated from items)
  totalItems    Int      @default(0)
  totalQuantity Decimal? @db.Decimal(14, 3)
  totalAmount   Decimal? @db.Decimal(16, 2)

  createdByUserId String?
  createdByUser   User?   @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  // ✅ NEW: Relation to items
  items       LoadItem[]
  attachments Attachment[]

  @@index([loadedAt])
}

// ============================================
// ✅ NEW: LoadItem (Multiple items per trip)
// Example: Potato 50 bags + Onion 30 bags + Tomato 10 crates
// ============================================

model LoadItem {
  id          String   @id @default(cuid())
  
  loadCardId  String
  loadCard    TripLoadCard @relation(fields: [loadCardId], references: [id], onDelete: Cascade)
  
  // Link to Item Master (optional - can use free text for ad-hoc items)
  itemId      String?
  item        Item?    @relation(fields: [itemId], references: [id], onDelete: SetNull)
  
  // Item details (denormalized for history + ad-hoc items)
  itemName      String   // "Potato", "Onion", "Tomato"
  itemNameHindi String?  // "आलू", "प्याज", "टमाटर"
  
  // Quantity
  quantity    Decimal  @db.Decimal(12, 3)
  unit        QuantityUnit @default(KG)
  customUnit  String?  // When unit is OTHER: "Petty", "Dandi", etc.
  
  // ✅ NEW: Pricing (for invoicing & Excel export)
  rate        Decimal? @db.Decimal(12, 2)  // ₹40.00 per bag
  amount      Decimal? @db.Decimal(14, 2)  // ₹2000.00 (qty × rate)
  
  // Quality grading (optional)
  grade       String?  // "A", "B", "Premium", "Regular"
  remarks     String?
  
  sortOrder   Int      @default(0)
  
  createdAt   DateTime @default(now())
  
  // Relation to corresponding receive item
  receiveItem ReceiveItem?
  
  @@index([loadCardId, sortOrder])
  @@index([itemId])
}

// ============================================
// ✅ UPDATED: TripReceiveCard (Multi-Item Support)
// ============================================

model TripReceiveCard {
  id        String   @id @default(cuid())
  tripId    String   @unique
  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  receivedAt DateTime @default(now())
  remarks    String?
  
  // ✅ NEW: Summary fields (auto-calculated from items)
  totalItems      Int      @default(0)
  totalQuantity   Decimal? @db.Decimal(14, 3)
  totalAmount     Decimal? @db.Decimal(16, 2)
  totalShortage   Decimal? @db.Decimal(14, 3)
  shortagePercent Decimal? @db.Decimal(5, 2)

  // Approval workflow
  status           String  @default("PENDING")
  approvedAt       DateTime?
  approvedByUserId String?
  approvedByUser   User?   @relation("ApprovedReceiveCards", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  disputeReason    String?

  createdByUserId String?
  createdByUser   User?   @relation("CreatedReceiveCards", fields: [createdByUserId], references: [id], onDelete: SetNull)

  // ✅ NEW: Relation to items
  items       ReceiveItem[]
  attachments Attachment[]

  @@index([receivedAt])
  @@index([status])
}

// ============================================
// ✅ NEW: ReceiveItem (With item-wise shortage)
// Example: Loaded 50 bags → Received 48 bags → Shortage 2 bags
// ============================================

model ReceiveItem {
  id            String   @id @default(cuid())
  
  receiveCardId String
  receiveCard   TripReceiveCard @relation(fields: [receiveCardId], references: [id], onDelete: Cascade)
  
  // Link to corresponding LoadItem (for shortage calculation)
  loadItemId    String?  @unique
  loadItem      LoadItem? @relation(fields: [loadItemId], references: [id], onDelete: SetNull)
  
  // Link to Item Master
  itemId        String?
  item          Item?    @relation(fields: [itemId], references: [id], onDelete: SetNull)
  
  // Item details (denormalized)
  itemName      String
  itemNameHindi String?
  
  // Quantity received
  quantity      Decimal  @db.Decimal(12, 3)
  unit          QuantityUnit @default(KG)
  customUnit    String?
  
  // ✅ NEW: Shortage (auto-calculated: loadItem.quantity - this.quantity)
  shortage        Decimal? @db.Decimal(12, 3)
  shortagePercent Decimal? @db.Decimal(5, 2)
  
  // ✅ NEW: Pricing
  rate          Decimal? @db.Decimal(12, 2)
  amount        Decimal? @db.Decimal(14, 2)
  
  // Quality assessment at destination
  grade         String?
  qualityIssue  String?  // "Damaged", "Rotten", "Wet"
  remarks       String?
  
  sortOrder     Int      @default(0)
  
  createdAt     DateTime @default(now())
  
  @@index([receiveCardId, sortOrder])
  @@index([itemId])
}

// ============================================
// TRIP EVENTS & TRACKING
// ============================================

model TripEvent {
  id              String       @id @default(cuid())
  tripId          String
  trip            Trip         @relation(fields: [tripId], references: [id], onDelete: Cascade)
  eventType       TripEventType
  description     String?
  metaJson        Json?
  atTime          DateTime     @default(now())
  createdByUserId String?
  createdByUser   User?        @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([tripId, atTime])
  @@index([eventType, atTime])
}

model TripLocation {
  id         String   @id @default(cuid())
  tripId     String
  trip       Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  driverId   String?
  driver     DriverProfile? @relation(fields: [driverId], references: [id], onDelete: SetNull)
  lat        Float
  lng        Float
  speed      Float?
  heading    Float?
  accuracy   Float?
  batchId    String?
  capturedAt DateTime
  createdAt  DateTime @default(now())

  @@index([tripId, capturedAt])
  @@index([driverId, capturedAt])
  @@index([batchId])
}

model TripLatestLocation {
  tripId     String   @id
  trip       Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  lat        Float
  lng        Float
  speed      Float?
  heading    Float?
  accuracy   Float?
  capturedAt DateTime
  updatedAt  DateTime @updatedAt
}

// ============================================
// LEDGER (KHATA) MODELS
// ============================================

model Account {
  id                String @id @default(cuid())
  ownerOrgId        String
  ownerOrg          Org    @relation("AccountOwnerOrg", fields: [ownerOrgId], references: [id], onDelete: Cascade)
  counterpartyOrgId String
  counterpartyOrg   Org    @relation("AccountCounterpartyOrg", fields: [counterpartyOrgId], references: [id], onDelete: Restrict)
  balance           BigInt @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entries   LedgerEntry[]
  invoices  Invoice[]
  payments  Payment[]
  threads   ChatThread[]

  @@unique([ownerOrgId, counterpartyOrgId])
  @@index([ownerOrgId])
  @@index([counterpartyOrgId])
}

model LedgerEntry {
  id            String          @id @default(cuid())
  accountId     String
  account       Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  tripId        String?
  trip          Trip?           @relation(fields: [tripId], references: [id], onDelete: SetNull)
  direction     LedgerDirection
  amount        BigInt
  balance       BigInt
  description   String?
  note          String?
  tag           PaymentTag?
  referenceType String?
  referenceId   String?
  createdAt     DateTime        @default(now())

  chatMessages ChatMessage[]

  @@index([accountId, createdAt])
  @@index([tripId])
}

model Invoice {
  id            String   @id @default(cuid())
  accountId     String
  account       Account  @relation(fields: [accountId], references: [id], onDelete: Restrict)
  tripId        String?
  trip          Trip?    @relation(fields: [tripId], references: [id], onDelete: SetNull)
  invoiceNumber String
  total         BigInt
  dueDate       DateTime?
  status        String   @default("OPEN")
  description   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments     Payment[]
  attachments  Attachment[]
  chatMessages ChatMessage[]

  @@unique([accountId, invoiceNumber])
  @@index([accountId, status])
  @@index([dueDate])
}

model Payment {
  id        String   @id @default(cuid())
  accountId String?
  account   Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  tripId    String?
  trip      Trip?    @relation(fields: [tripId], references: [id], onDelete: SetNull)

  // Amount
  amount    BigInt

  // Payment Status Flow
  status    PaymentStatus @default(PENDING)

  // Payment method details
  mode      String?       // "UPI", "BANK_TRANSFER", "CASH", "CHEQUE"
  tag       PaymentTag?   // ADVANCE, PARTIAL, FINAL, DUE, OTHER

  // Sender's proof (when marking as paid)
  markedPaidAt    DateTime?
  markedPaidBy    String?
  markedPaidUser  User?     @relation("MarkedPaidPayments", fields: [markedPaidBy], references: [id], onDelete: SetNull)
  utrNumber       String?   // UTR/Transaction reference (optional)
  proofNote       String?   // Any note from sender

  // Receiver's confirmation
  confirmedAt     DateTime?
  confirmedBy     String?
  confirmedUser   User?     @relation("ConfirmedPayments", fields: [confirmedBy], references: [id], onDelete: SetNull)

  // Dispute handling
  disputedAt      DateTime?
  disputedBy      String?
  disputedUser    User?     @relation("DisputedPayments", fields: [disputedBy], references: [id], onDelete: SetNull)
  disputeReason   String?

  // Legacy fields (keep for backward compatibility)
  reference String?       // Old transaction ID field
  remarks   String?
  paidAt    DateTime?     // Set when CONFIRMED (not when created)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attachments  Attachment[]
  chatMessages ChatMessage[]

  @@index([accountId, status])
  @@index([accountId, paidAt])
  @@index([invoiceId, paidAt])
  @@index([tripId, paidAt])
  @@index([status, createdAt])
}

model Dispute {
  id        String @id @default(cuid())
  tripId    String
  trip      Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)
  reason    String
  status    String @default("OPEN")
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
}

// ============================================
// CHAT MODELS
// ============================================

model ChatThread {
  id        String @id @default(cuid())
  orgId     String
  org       Org    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  accountId String?
  account   Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  tripId    String?
  trip      Trip?   @relation(fields: [tripId], references: [id], onDelete: SetNull)

  title           String?
  type            String  @default("GENERAL")
  lastMessageAt   DateTime?
  lastMessageText String?
  unreadCount     Int @default(0)
  isArchived      Boolean @default(false)
  isPinned        Boolean @default(false)
  pinnedAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages         ChatMessage[]

  @@unique([accountId])
  @@unique([tripId])
  @@index([orgId, updatedAt])
  @@index([orgId, lastMessageAt])
  @@index([orgId, isPinned, lastMessageAt])
  @@index([accountId, updatedAt])
  @@index([tripId, updatedAt])
}

model ChatMessage {
  id           String @id @default(cuid())
  threadId     String
  thread       ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  senderUserId String?
  senderUser   User? @relation("SentMessages", fields: [senderUserId], references: [id], onDelete: SetNull)

  content     String?
  messageType ChatMessageType @default(TEXT)
  metadata    Json?           // Stores structured data for cards (trip details, payment info, excel rows)
  tag         PaymentTag?

  paymentId     String?
  payment       Payment?     @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  invoiceId     String?
  invoice       Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  ledgerEntryId String?
  ledgerEntry   LedgerEntry? @relation(fields: [ledgerEntryId], references: [id], onDelete: SetNull)

  isRead      Boolean @default(false)
  readAt      DateTime?
  isDelivered Boolean @default(false)
  deliveredAt DateTime?
  isEdited    Boolean @default(false)
  editedAt    DateTime?
  replyToId   String?
  replyTo     ChatMessage? @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies     ChatMessage[] @relation("MessageReplies")

  locationLat Float?
  locationLng Float?

  attachments Attachment[]

  createdAt DateTime @default(now())

  @@index([threadId, createdAt])
  @@index([paymentId])
  @@index([invoiceId])
  @@index([senderUserId, createdAt])
  @@index([threadId, isRead, senderUserId])
  @@index([threadId, senderUserId, isRead])
}

// ============================================
// ATTACHMENTS
// ============================================

model Attachment {
  id        String         @id @default(cuid())
  type      AttachmentType @default(OTHER)
  url       String
  s3Key     String?        @unique
  mimeType  String?
  fileName  String?
  sizeBytes Int?
  status    String         @default("PENDING")
  uploadedBy String?

  createdAt DateTime @default(now())

  loadCardId    String?
  loadCard      TripLoadCard?    @relation(fields: [loadCardId], references: [id], onDelete: Cascade)
  receiveCardId String?
  receiveCard   TripReceiveCard? @relation(fields: [receiveCardId], references: [id], onDelete: Cascade)
  invoiceId     String?
  invoice       Invoice?         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  paymentId     String?
  payment       Payment?         @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  messageId     String?
  message       ChatMessage?     @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([type, createdAt])
  @@index([status])
  @@index([invoiceId])
  @@index([paymentId])
  @@index([messageId])
}

// ============================================
// ✅ NEW: EXPORT AUDIT LOG
// Track all exports for GST compliance
// ============================================

model ExportLog {
  id        String   @id @default(cuid())
  
  orgId     String
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Export details
  exportType  String   // "LEDGER", "TRIPS", "FULL_REPORT"
  format      String   // "XLSX", "PDF", "CSV"
  
  // Date range
  startDate   DateTime
  endDate     DateTime
  
  // Filters applied
  counterpartyOrgId String?
  filtersJson       Json?
  
  // File info
  fileName    String
  s3Key       String?
  fileSize    Int?
  rowCount    Int?
  
  createdByUserId String
  createdByUser   User   @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  
  @@index([orgId, createdAt])
  @@index([createdByUserId])
  @@index([exportType, createdAt])
}

// ============================================
// DRIVER PAYMENT MODEL
// Flexible driver payment: source pays, dest pays, or split
// ============================================

model DriverPayment {
  id                   String               @id @default(cuid())
  tripId               String               @unique
  trip                 Trip                  @relation(fields: [tripId], references: [id], onDelete: Cascade)

  totalAmount          Decimal              @db.Decimal(12, 2)
  paidBy               DriverPaymentPaidBy  @default(SOURCE)

  // Split amounts (only when paidBy = SPLIT)
  splitSourceAmount    Decimal?             @db.Decimal(12, 2)
  splitDestAmount      Decimal?             @db.Decimal(12, 2)

  // Payment tracking
  paidAmount           Decimal              @default(0) @db.Decimal(12, 2)
  status               DriverPaymentStatus  @default(PENDING)
  paidAt               DateTime?
  remarks              String?

  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  @@index([status])
  @@index([tripId])
}
